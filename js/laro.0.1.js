(function(m,j){function c(g){g=a.call(g).toLowerCase();return g.substring(8,g.length-1)}function e(g,i,k){var l=-1,n=b.call(arguments,0);g=h[d.$name]||{};i=[];for(k=true;n[++l];)if(c(n[l])==="boolean")k=n[l];else c(n[l])==="object"&&i.push(n[l]);if(i.length>=2)g=i.splice(0,1)[0];for(l=0;l<i.length;l++){n=i[l];for(var o in n)if(!g.hasOwnProperty(o)||k)g[o]=n[o]}return g}var d={$name:"Laro",$version:"0.1",$description:"game engine based on html5"},a=Object.prototype.toString,b=Array.prototype.slice,
h=this||m,f=e({},d,{toType:c,extend:e,register:function(g,i){var k=g.split("."),l=-1,n=h;if(k[0]=="")k[0]=d.$name;for(;k[++l];){if(n[k[l]]===j)n[k[l]]={};n=n[k[l]]}i&&i.call(n,h[d.$name])},randomRange:function(g,i){return g+Math.random()*(i-g)},randomBool:function(){return Math.random()>=0.5},curry:function(g,i){return function(){typeof g=="function"&&g.apply(i,arguments)}},curryWithArgs:function(g,i){var k=Array.prototype.slice.call(arguments,0);delete k[0];delete k[1];return function(){typeof g==
"function"&&g.apply(i,k.concat(arguments))}}});this[d.$name]=m[d.$name]=f})(window);
(function(m,j){var c=Object.prototype.toString,e={};e.isArray=Array.isArray||function(a){return c.call(a)==="[object Array]"};e.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)};e.isObject=function(a){return a===Object(a)};var d=function(a,b,h){function f(o){var q=o;if(o&&o.substring(0,4)=="url(")q=o.substring(4,o.length-1);return!d.registered[q]&&(!d.__checkURLs||!d.__checkURLs[q])&&o&&o.length>4&&o.substring(0,4)=="url("}var g=-1,i=[];if(e.isArray(a)){g=a;for(var k=0;k<g.length;k++)if(d.registered[g[k]]||
f(g[k]))i.push(g[k]);a=i[0];g=1}else for(;typeof arguments[++g]=="string";)if(d.registered[a]||f(a))i.push(arguments[g]);b=arguments[g];h=arguments[++g];if(i.length>1){var l=b;b=function(){d(i,l,h)}}g=d.registered[a];if(!d.__checkURLs)d.__checkURLs={};if(f(a)&&a.substring(0,4)=="url("){a=a.substring(4,a.length-1);if(!d.__checkURLs[a]){i[0]=a;d.register(a,a);g=d.registered[a];k=d.prototype.getCallbackQueue(a);var n=new d.prototype.curCallBack(function(){d.__checkURLs[a]=true});k.push(n);k.push(new d.prototype.curCallBack(b,
h));h=b=j}}if(g){for(k=g.requirements.length-1;k>=0;k--)if(d.registered[g.requirements[k].name]){d(g.requirements[k].name,function(){d(a,b,h)},h);return}for(k=0;k<g.urls.length;k++)if(k==g.urls.length-1)b?d.load(g.name,g.urls[k],g.isAsyn,g.asyncWait,new d.prototype.curCallBack(b,h)):d.load(g.name,g.urls[k],g.isAsyn,g.asyncWait);else d.load(g.name,g.urls[k],g.isAsyn,g.asyncWait)}else b&&b.call(h)};d.prototype={register:function(a,b,h,f){if(e.isObject(a)){b=a;b=new d.prototype.__register(b.name,b.isAsyn,
b.asyncWait,f)}else b=new d.prototype.__register(a,b,h,f);if(!d.registered)d.registered={};d.registered[a]&&window.console&&window.console.log('Warning: Module named "'+a+'" was already registered, Overwritten!!!');return d.registered[a]=b},__register:function(a,b,h){this.name=a;var f=0,g=arguments[++f];if(g&&typeof g=="boolean"){this.isAsyn=g;g=arguments[++f]}else this.isAsyn=true;this.asyncWait=g&&typeof g=="number"?h:0;this.urls=[];if(g&&g.length&&typeof g!="string")this.urls=g;else for(f=f;f<
arguments.length;f++)arguments[f]&&typeof arguments[f]=="string"&&this.urls.push(arguments[f]);this.requirements=[];this.require=function(i){var k=[];k=Object.prototype.toString.call(i)=="[object Array]"&&i.length?i:Array.prototype.slice.call(arguments,0);for(var l=0;l<k.length;l++)this.requirements.push({name:k[l]});return this};this.register=function(i,k,l,n){return d.register(i,k,l,n)};return this},defaultAsyncTime:10,load:function(a,b,h,f,g){if(f==j)f=d.defaultAsyncTime;if(!d.loadedscripts)d.loadedscripts=
[];var i=d.prototype.getCallbackQueue(b);i.push(new d.prototype.curCallBack(function(){d.loadedscripts.push(d.registered[a]);d.registered[a]=j},null));if(g){i.push(g);if(i.length>2)return}h?d.asynLoadScript(a,b,f,i):d.xhrLoadScript(a,b,i)},xhrLoadScript:function(a,b,h){var f;if(window.XMLHttpRequest)f=new XMLHttpRequest;else if(window.ActiveXObject)f=new ActiveXObject("Microsoft.XMLHTTP");f.onreadystatechange=function(){if(f.readyState==4&&f.status==200){d.injectScript(f.responseText,a);d.loadProgressCallback&&
d.loadProgressCallback(a,b);if(h)for(var g=0;g<h.length;g++)h[g].runCallback();d.__callbackQueue[b]=j}};h.length>1?f.open("GET",b,true):f.open("GET",b,false);f.send(null)},asynLoadScript:function(a,b,h,f){var g=d.prototype.createScriptNode();g.setAttribute("src",b);if(f){var i=function(){d.__callbackQueue[b]=j;for(var k=0;k<f.length;k++)f[k].runCallback();f=[]};g.onload=g.onreadystatechange=function(){if(!g.readyState||g.readyState=="loaded"||g.readyState=="complete"||g.readyState==4&&g.status==200)h>
0?setTimeout(i,h):i()}}document.getElementsByTagName("head")[0].appendChild(g);d.loadProgressCallback&&d.loadProgressCallback(a,b)},curCallBack:function(a,b){this.callback=a;this.context=b;this.runCallback=function(){this.callback&&(this.context?this.callback.call(this.context):this.callback())}},getCallbackQueue:function(a){if(!d.__callbackQueue)d.__callbackQueue={};var b=d.__callbackQueue[a];b||(b=d.__callbackQueue[a]=[]);return b},createScriptNode:function(){var a=document.createElement("script");
a.setAttribute("type","text/javascript");a.setAttribute("language","Javascript");return a},injectScript:function(a,b){var h=d.prototype.createScriptNode();try{h.setAttribute("name",b)}catch(f){}h.text=a;document.getElementsByTagName("head")[0].appendChild(h)}};d.register=d.prototype.register;d.load=d.prototype.load;d.defaultAsyncTime=d.prototype.defaultAsyncTime;d.asynLoadScript=d.prototype.asynLoadScript;d.xhrLoadScript=d.prototype.xhrLoadScript;Laro.extend({module:d,use:d,multiModule:function(a,
b,h){var f=-1,g=0,i=[];if(e.isArray(a))i=a;else{for(;e.isString(arguments[++f]);)i.push(arguments[f]);b=arguments[f];h=arguments[++f]}f=0;for(var k=i.length;f<k;f++)d(i[f],function(){g++;g==i.length&&b&&b.call(h)})}})})(window);
Laro.register(".err",function(){function m(e){this.assign(e)}function j(e){this.assign(e)}function c(e){this.assign(e)}m.prototype=Error();m.prototype.constructor=m;m.prototype.assign=function(e){this.message=e===undefined?"":e};j.prototype=new m;j.prototype.constructor=j;c.prototype=new m;c.prototype.constructor=c;this.assert=function(e,d){if(!e)throw new j(d);};this.RuntimeException=m;this.AssertionError=j;this.Exception=c;Laro.extend(this)});
Laro.register(".base",function(){function m(g){return e.call(typeof g===b?g:function(){},g,1)}function j(g,i,k){return function(){var l=this.supr;this.supr=k[f][g];var n=i.apply(this,arguments);this.supr=l;return n}}function c(g,i,k){for(var l in i)if(i.hasOwnProperty(l))g[l]=typeof i[l]===b&&typeof k[f][l]===b&&h.test(i[l])?j(l,i[l],k):i[l]}function e(g,i){function k(){}function l(){if(this.initialize)this.initialize.apply(this,arguments);else{i||q&&n.apply(this,arguments);p.apply(this,arguments)}}
k[f]=this[f];var n=this,o=new k,q=typeof g===b,p=q?g:this,r=q?{}:g;l.methods=function(s){c(o,s,n);l[f]=o;return this};l.methods.call(l,r).prototype.constructor=l;l.extend=arguments.callee;l[f].implement=l.statics=function(s,t){s=typeof s=="string"?function(){var u={};u[s]=t;return u}():s;c(this,s,n);return this};return l}var d=this,a=d.Class,b="function",h=/xyz/.test(function(){})?/\bsupr\b/:/.*/,f="prototype";m.noConflict=function(){d.Class=a;return this};d.Class=m;Laro.Class=m});
Laro.register(".geometry",function(m){var j=m.err.assert;m=m.base.Class;var c=m({initialize:function(e,d,a,b){j(e>=0&&e<=255,"Pixel32 wrong --\> r");j(d>=0&&d<=255,"Pixel32 wrong --\> g");j(a>=0&&a<=255,"Pixel32 wrong --\> b");this.r=e;this.g=d;this.b=a;this.a=b===undefined?255:b;this.normalized=[e/255,d/255,a/255,this.a>1?this.a/255:this.a]},equal:function(e){return e instanceof c?this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a:false},toString:function(){return"rgba("+this.r+", "+this.g+", "+
this.b+", "+this.normalized[3]+")"},rgbString:function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"}});this.Pixel32=c;Laro.extend(this)});
Laro.register(".game",function(m){var j=m.Pixel32||m.geometry.Pixel32,c=m.toType;m=(m.Class||m.base.Class)(function(a,b,h){if(!(a==undefined||c(a)!="object")){this.host=a;this.fsm=b;this.stateId=h;this.isSuspended=false}}).methods({enter:function(){throw"no enter";},leave:function(){throw"no leave";},update:function(){throw"no update";},suspended:function(){throw"no suspended";},message:function(){throw"no message";},suspend:function(){throw"no suspend";},resume:function(){throw"no resume";},preload:function(){throw"no preload";
},cancelPreload:function(){throw"no cancelPreload";},transition:function(){return false}});var e=m.extend(function(a,b,h,f){this.stateId=a;a=function(){};this.isSuspended=false;this.enter=b!=null?b:a;this.leave=h!=null?h:a;this.update=f!=null?f:a}),d=m.extend(function(){this.isSuspended=false;this.dimTimeLeft=0}).methods({update:function(a){this.dimTimeLeft-=a;if(this.dimTimeLeft<0)this.dimTimeLeft=0},draw:function(a){if(this.dimTimeLeft>0){var b=new j(0,0,0,Math.min(255,765*this.dimTimeLeft));a.drawQuad(null,
b)}},suspended:function(){this.dimTimeLeft=0.25},onMouse:function(){throw"no onMouse";}});this.BaseState=m;this.SimpleState=e;this.AppState=d});
Laro.register(".game",function(m){var j=m.SimpleState||m.game.SimpleState,c=(m.Class||m.base.Class)(function(e,d,a){if(e!=undefined){this.host=e;this.onStateChange=a;this.stateArray=[];for(a=0;a<d.length;a+=2){var b=d[a],h=d[a+1];this.stateArray[b]=h instanceof j?h:new h(e,this,b)}this.currentState=c.kNoState;this.numSuspended=0;this.suspendedArray=[];this.numPreloaded=0;this.preloadedArray=[];this.numStates=this.stateArray.length}}).methods({enter:function(e,d){this.setState(e,d)},leave:function(){this.setState(c.kNoState)},
update:function(e){for(var d=0;d<this.numSuspended;d++)this.stateArray[this.suspendedArray[d]].suspended(e);if(this.currentState!=c.kNoState){this.stateArray[this.currentState].update(e);this.currentState!=c.kNoState&&this.stateArray[this.currentState].transition()}},message:function(e){this.currentState!=c.kNoState&&this.stateArray[this.currentState].message(e)},messageSuspended:function(e){for(var d=0;d<this.numSuspended;d++)this.stateArray[this.suspendedArray[d]].message(e)},tryChangeState:function(e,
d,a,b,h){if(b==undefined)b=true;if(h==undefined)h=true;if(d==c.kNextState)d=this.currentState+1;if(e&&(d!=this.currentState||b)){console.log(d);this.setState(d,a,h);return true}return false},setState:function(e,d,a){if(e==c.kNextState)e=this.currentState+1;if(e==c.kNoState){for(;this.numSuspended>0;this.numSuspended--){this.stateArray[this.suspendedArray[this.numSuspended-1]].leave();this.stateArray[this.suspendedArray[this.numSuspended-1]].isSuspended=false}for(;this.numPreloaded>0;this.numPreloaded--)this.stateArray[this.preloadedArray[this.numPreloaded-
1]].cancelPreload()}else if(a){this.stateArray[this.currentState].suspended();this.stateArray[this.currentState].isSuspended=true;this.suspendedArray[this.numSuspended++]=this.currentState}else{this.currentState!=c.kNoState&&this.stateArray[this.currentState].leave();if(!this.stateArray[e].isSuspended)for(;this.numSuspended>0;this.numSuspended--){this.stateArray[this.suspendedArray[this.numSuspended-1]].leave();this.stateArray[this.suspendedArray[this.numSuspended-1]].isSuspended=false}}for(a=0;a<
this.numPreloaded;a++)this.preloadedArray[a]!=e&&this.stateArray[this.preloadedArray[a]].cancelPreload();this.numPreloaded=0;this.onStateChange!=undefined&&this.onStateChange(this.currentState,e,d);a=this.currentState;this.currentState=e;if(this.currentState!=c.kNoState)if(this.stateArray[this.currentState].isSuspended){this.stateArray[this.currentState].resume(d,a);this.stateArray[this.currentState].isSuspended=false;--this.numSuspended}else this.stateArray[this.currentState].enter(d,a)},getCurrentState:function(){if(this.currentState==
c.kNoState)return null;return this.stateArray[this.currentState]},preload:function(e){this.preloadedArray[this.numPreloaded++]=e},isSuspended:function(e){return this.stateArray[e].isSuspended}}).statics({kNoState:-1,kNextState:-2});m=c.extend().methods({draw:function(e){for(var d=0;d<this.numSuspended;d++)this.stateArray[this.suspendedArray[d]].draw(e);(d=this.getCurrentState())&&d.draw(e)},onMouse:function(e,d,a,b){var h=this.getCurrentState();h&&h.onMouse(e,d,a,b)}});this.FSM=c;this.AppFSM=m;Laro.extend(this)});
Laro.register(".game",function(m){var j=m.base.Class||m.Class;window.requestAnimationFrame=this.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1)}}();var c=j(function(e,d){function a(){if(b){requestAnimationFrame(a);var f=new Date,g=(f-h)/1E3;if(g>=3)g=0.25;e.call(d,g);h=f}}var b=true,h=new Date;this.stop=function(){b=
false};this.resume=function(){b=true;h=new Date;a()};a();return this});j=j(function(e,d,a){this.maxTime=a;this.from=e;this.to=d;this.time=0;this.isDone=false}).methods({update:function(e){this.time=Math.min(this.time+e,this.maxTime)},draw:function(e){this.isDone=this.time==this.maxTime;var d=new m.Pixel32(m.lerp(this.from.r,this.to.r,this.time/this.maxTime),m.lerp(this.from.g,this.to.g,this.time/this.maxTime),m.lerp(this.from.b,this.to.b,this.time/this.maxTime),m.lerp(this.from.a,this.to.a,this.time/
this.maxTime));d.a>0&&e.drawFillScreen(d)},reset:function(){this.time=0;this.isDone=false}});this.Loop=c;this.ScreenTransitionFade=j;Laro.extend(this)});
Laro.register(".game",function(m){var j=m.Class(function(c,e){this.url=c;this.loaded=false;this.callback=e;this.channels={};this.currentChannel=null;this.genAudio();if(this.can=this.canPlayThisType()){this.bind();this.audio.load()}else this.callback&&this.callback()}).methods({genAudio:function(){this.audio=new Audio;this.audio.src=this.url;this.audio.preload="auto";if(this.audio.play&&navigator.userAgent.toLowerCase().indexOf("msie")<0){this.audio.play();this.audio.pause()}},canPlayThisType:function(c){var e=
{mp3:"audio/mpeg;",m4a:"audio/aac",ogg:'audio/ogg; codecs="vorbis"',wav:"audio/wav"};if(c==undefined)c=this.url.substr(this.url.lastIndexOf(".")).replace(/\./g,"");return!!(this.audio&&this.audio.canPlayType&&this.audio.canPlayType(e[c]).replace(/no/,""))},bind:function(){var c=this;this.audio.addEventListener("loadedmetadata",function(){c.addChannel("default",0,c.getDuration())},false);this.audio.addEventListener("playing",function(){},false);this.audio.addEventListener("timeupdate",function(){},
false);this.audio.addEventListener("canplaythrough",function(){c.loaded=true;!c.channels["default"]&&c.addChannel("default",0,c.getDuration());c.callback&&c.callback()},false)},update:function(){},getVolume:function(){return this.audio.volume},setVolume:function(c){c=Math.max(0,Math.min(c,100));this.audio.volume=c},haveData:function(){var c=this.audio.readyState;if(c==1||!c)return false;else if(c==2||c==3||c==4||c==5)return true},isPlayingChannel:function(c){return!this.audio.paused&&c===this.currentChannel.name},
getDuration:function(){return this.audio.duration},getCurrentChannel:function(){return this.currentChannel},addChannel:function(c,e,d){if(m.toType(c)=="object"){c=c.name;e=c.start;d=c.duration}var a=this.getDuration();if(e>a)throw"Sound channel start wrong!";if(e+d>a)d=a-e;this.channels[c]={start:e,end:e+d,duration:d};return this.channels[c]},removeChannel:function(c){delete this.channels[c]},pause:function(){return this.audio.pause()},preloadChannel:function(c){this.pause();if(c=this.channels[c])this.audio.currentTime=
c.start},play:function(c,e){if(this.can){var d=this,a=-1;if(c==undefined)c="default";if(e==undefined)e=false;this.currentChannel&&clearTimeout(this.currentChannel.timer);if(this.haveData()){var b=this.channels[c];clearTimeout(b.timer);this.audio.currentTime=b.start;this.audio.play();if(e)a=setTimeout(function(){d.play(c,e)},b.duration*1E3);this.currentChannel={name:c,start:b.start,duration:b.duration,end:b.end,isLoop:e,startTime:+new Date,timer:a}}}}}).statics({CAN_PLAY_TYPES:function(){var c=document.createElement("audio"),
e={};if(typeof c.canPlayType==="function"){e._supported=Boolean(true);e.mp3=c.canPlayType("audio/mpeg");e.wav=c.canPlayType('audio/wav; codecs="1"');e.ogg=c.canPlayType('audio/ogg; codecs="vorbis"');e.m4a=c.canPlayType("audio/x-m4a")||c.canPlayType("audio/aac");e.webm=c.canPlayType('audio/webm; codecs="vorbis"')}else e._supported=Boolean(0);return e}()});this.Sound=j;m.extend({Sound:j})});
Laro.register(".game",function(m){var j=m.base.Class,c=m.toType,e=m.geometry.Pixel32,d=j(function(f){this.name=f.name;this.filename=f.filename;this.sources={};for(var g in f.sources)if(f.sources.hasOwnProperty(g)){var i=f.sources[g];this.sources[i.name]=i.data}}),a=function(f){var g=f.lastIndexOf(".");g=f.substr(g);if(/png|jpg|jpeg|gif|bmp/.test(g))return"image";else if(/ogg|mp3|m4a|wav/.test(g))return"sound"},b=j(function(f){this.basePath=this.imagePath=f||"resources/";this.loadedImages={};this.loadedSounds=
{}}).methods({loadImage:function(f){var g=this.loadedImages[f];if(g)return g;g=new Image;g.src=this.imagePath+f;return this.loadedImages[f]=g},preloadImages:function(f,g){var i=0,k=[],l=-1,n=arguments;if(c(f)=="array")k=f;else{for(;c(n[++l])=="string";)k.push(n[l]);g=n[l]}var o=k.length;l=function(){i++;g&&g(i/o)};n=function(){console.log("an image load error")};for(var q=0;q<o;q++){var p=k[q],r=this.loadedImages[p];if(r!=undefined)i++;else{r=new Image;r.src=this.imagePath+p;r.onload=l;r.onerror=
n;this.loadedImages[p]=r}}g&&g(i/o)},preload:function(f,g){var i=0,k=[],l=-1,n=arguments;if(c(f)=="array")k=f;else{for(;c(n[++l])=="string";)k.push(n[l]);g=n[l]}var o=k.length;l=function(){i++;g&&g(i/o)};for(n=0;n<o;n++){var q=k[n];if(a(q)=="image"){var p=this.loadedImages[q];if(p)i++;else{p=new Image;p.src=this.basePath+q;p.onload=l;p.onerror=l;this.loadedImages[q]=p}}else if(a(q)=="sound")if(p=this.loadedSounds[q])i++;else{p=new m.Sound(this.basePath+q,l);this.loadedSounds[q]=p}}g&&g(i/o)}}).statics({getInstance:function(){if(b.instance===
null)b.instance=new b(this.imagePath);return b.instance},instance:null}),h=j(function(f,g,i,k){k=k==undefined?null:k;this.image=f;this.shapes=g;this.index=i;this.name=k});j=j(function(f){this.baseColor=new e(f.base_r,f.base_g,f.base_b);this.outlineColor=new e(f.outline_r,f.outline_g,f.outline_b);this.size=f.size;this.font=f.font;this.outline=f.outline}).methods({getFont:function(){var f=[];f.push("normal");f.push(this.size+"px");f.push(this.font);return f.join(" ")},generateCanvas:function(f,g){var i=
document.createElement("canvas"),k=i.getContext("2d");k.font=this.getFont();var l=this.outline*2;if(g!=undefined){f=this.wrapText(k,f,g);i.width=k.measureText(f).width+8+l*2;i.height=(this.size+l*4)*f.split("\n").length}else{i.width=k.measureText(f).width+8+l*2;i.height=this.size+l*4}k.fillStyle=this.baseColor.toString();k.textBaseline="middle";k.textAlign="left";k.font=this.getFont();if(l!=0){k.strokeStyle=this.outlineColor.toString();k.lineWidth=l;k.strokeText(f,l,this.size/2+l*2)}k.fillText(f,
l,this.size/2+l*2);return i},wrapText:function(f,g,i){var k="";g=g.split(" ");for(var l=0;l<g.length;){k+=f.measureText(k+g[l]).width>=i?"\n"+g[l]:l!=0?" "+g[l]:g[l];l++}return k}});this.Atlas=d;this.ResourceLoader=b;this.Tile=h;this.Font=j;Laro.extend(this)});
Laro.register(".action",function(m){var j=m.extend;this.Animation=(m.Class||m.base.Class)(function(c,e){j(this,c);this.frames=e;if(c.framerate==undefined)c.framerate=20;this.animationLength=e.length/c.framerate}).methods({getEvents:function(c,e){for(var d=[],a=0;a<this.events.length;a++){var b=this.events[a];b.time>=c&&b.time<e&&d.push(b.name)}return d},getTimeForNextEvent:function(c,e){for(var d=-1,a=0;a<this.events.length;a++){var b=this.events[a];if(b.time>c&&b.time<e){if(d!=-1)break;d=b.time}}return d},
getEventsSlow:function(c,e,d,a){var b=[],h,f;for(h=0;h<this.events.length;h++){f=this.events[h];f.time>=c&&f.time<a&&b.push(f.name)}for(h=0;h<this.events.length;h++){f=this.events[h];f.time>=d&&f.time<e&&b.push(f.name)}return b}});Laro.extend(this)});
Laro.register(".action",function(m){var j=(m.Class||m.base.Class)(function(c,e,d){if(c instanceof j)c=c.animation;if(d==undefined)d=false;this.animation=c;this.callback=e==undefined?null:e;this.time=this.currentFrame=0;this.renderMirrored=d;this.speed=1;this.start=0;this.end=1;this.playTo=-1;this.loop=true;this.playing=false}).methods({clone:function(){var c=new j(this.animation,this.callback,this.renderMirrored);c.start=this.start;c.end=this.end;c.time=this.time;return c},update:function(c){if(this.playing){var e=
this.time;this.time+=this.speed*c;var d=0.5/this.animation.framerate,a=this.animation.animationLength;if(this.loop)this.time=this.speed>0?this.time>=a*this.end?this.start*a:this.time:this.time<=a*this.start?this.end*a-d:this.time;else{var b;if(this.speed>0){b=this.playTo>=0?this.playTo:this.end;if(this.time>=a*b){this.time=a*b-d;this.playing=false}}else{b=this.playTo>=0?this.playTo:this.start;if(this.time<=a*b){this.time=a*b+d;this.playing=false}}}this.time=Math.max(this.time,0);this.currentFrame=
Math.floor(this.time*this.animation.framerate)%this.animation.nbrOfFrames;if(this.callback!=null){d=this.playing?this.time:this.speed>0?a*this.end:this.animation.animationLength*this.start;c=e<d?this.animation.getEvents(e,d):this.animation.getEventsSlow(e,d,a*this.start,a*this.end,c);if(c.length>=2){this.time=this.animation.getTimeForNextEvent(e,d);c=[c[0]]}for(e=0;e<c.length;e++)this.callback(c[e],this);this.playing||this.callback("stopped",this)}}else this.currentFrame=Math.floor(this.time*this.animation.framerate)%
this.animation.nbrOfFrames},draw:function(c,e,d,a,b,h){var f=this.animation.frames[this.currentFrame];c.drawImage(f,this.renderMirrored?e-(f.textureWidth-this.animation.pivotx):e-this.animation.pivotx,d-this.animation.pivoty,a,false,b,h,this.renderMirrored)},mirror:function(){this.renderMirrored=!this.renderMirrored},play:function(c){this.playTo=-1;if(c==undefined)c=true;if(this.time>=this.end*this.animation.animationLength-0.5/this.animation.framerate)this.time=this.start*this.animation.animationLength;
this.loop=c;this.playing=true},playToTime:function(c){this.playTo=c;if(this.time>=this.playTo*this.animation.animationLength-0.5/this.animation.framerate)this.time=this.start*this.animation.animationLength;this.playing=true},playToEvent:function(c){for(var e=0;e<this.animation.events.length;e++){var d=this.animation.events[e];if(d.name==c){this.playToTime(d.time/this.animation.animationLength);break}}},stop:function(){this.playing=false},rewind:function(){this.time=this.start*this.animation.animationLength},
gotoTime:function(c){this.time=c*this.animation.animationLength},gotoEvent:function(c){for(var e=0;e<this.animation.events.length;e++){var d=this.animation.events[e];if(d.name==c){this.time=d.time;break}}},gotoEnd:function(){this.time=(this.end-0.5/this.animation.framerate)*this.animation.animationLength},setRange:function(c,e){this.start=c;this.end=e;var d=this.animation.animationLength;if(this.time<c*d)this.time=c*d;if(this.time>e*d)this.time=e*d},setSpeed:function(c){this.speed=c},getLength:function(){return this.animation.animationLength*
(this.end-this.start)},getCurrentPosition:function(){return this.time},isStopped:function(){return!this.playing},setCallback:function(c){this.callback=c}});this.AnimationHandle=j;Laro.extend(this)});
Laro.register(".texture",function(m){var j=m.err.assert;this.EMBImage=this.ImageRegion=m=(m.base.Class||la.Class)(function(c,e,d,a,b,h,f,g,i){j(c instanceof HTMLImageElement||c instanceof HTMLCanvasElement,"invalid image");this.image=c;this.x=e;this.y=d;this.width=a;this.height=b;this.offsetX=h==null?0:h;this.offsetY=f==null?0:f;this.textureWidth=g==null?a:g;this.textureHeight=i==null?b:i;this.hasPadding=h>0||f>0||g>a||i>b}).methods({getImageWidth:function(){return this.image.width},getImageHeight:function(){return this.image.height}});
Laro.extend(this)});
Laro.register(".geometry",function(m){m=m.base.Class;var j=m({initialize:function(c,e){this.x=c;this.y=e},magnitudeSquared:function(){return this.x*this.x+this.y*this.y},magnitude:function(){return Math.sqrt(this.magnitudeSquared())},add:function(c){this.x+=c.x;this.y+=c.y;return this},addNew:function(c){return new j(this.x+c.x,this.y+c.y)},sub:function(c){this.x-=c.x;this.y-=c.y;return this},subNew:function(c){return new j(this.x-c.x,this.y-c.y)},mul:function(c){this.x*=c;this.y*=c;return this},
mulNew:function(c){return new j(this.x*c,this.y*c)},div:function(c){this.x/=c;this.y/=c;return this},divNew:function(c){return new j(this.x/c,this.y/c)},equal:function(c){return this.x===c.x&&this.y===c.y},notEqual:function(c){return this.x!==c.x||this.y!==c.y},copy:function(){return new j(this.x,this.y)}});this.Point2=j;Laro.extend(this)});
Laro.register(".geometry",function(m){var j=m.geometry.Point2.extend({dot:function(c){return this.x*c.x+this.y*c.y},cross:function(c){return this.x*c.x-this.y*c.y},length:function(){return this.magnitude()},normalize:function(){var c=1/this.length();this.x*=c;this.y*=c;return this},copy:function(){return new j(this.x,this.y)}});j.zero=new j(0,0);j.X=new j(1,0);j.Y=new j(0,1);this.Vector2=j;Laro.extend(this)});
Laro.register(".geometry",function(m){this.Circle=function(a,b){this.c=a;this.r=b};m.Circle=this.Circle;var j=m.geometry.Vector2,c=m.geometry.Point2,e=m.geometry.Circle||this.Circle,d=(m.base.Class||m.Class)(function(a,b,h,f){this.x0=a;this.x1=h;this.y0=b;this.y1=f;this.width=h-a+1;this.height=f-b+1}).methods({center:function(){return new j((this.x0+this.x1+1)/2,(this.y0+this.y1+1)/2)},invertBy:function(a){a=a||"x";if(a=="x")return new d(-this.x1,this.y0,-this.x0,this.y1);else if(a=="y")return new d(this.x0,
-this.y1,this.x1,-this.y0)},offset:function(a,b){if(a instanceof j||a instanceof c){a=a.x;b=a.y}return new d(this.x0+a,this.y0+b,this.x1+a,this.y1+b)},expand:function(a,b){if(a instanceof j||a instanceof c){a=a.x;b=a.y}return new d(this.x0-a,this.y0-b,this.x1+a,this.y1+b)},contains:function(a,b){return a instanceof j||a instanceof c?this.x0<=a.x&&this.y0<=a.y&&this.x1>=a.x&&this.y1>=a.y:a instanceof d?this.x0<=a.x0&&this.y0<=a.y0&&this.x1>=a.x1&&this.y1>=a.y1:this.x0<=a&&this.y0<=b&&this.x1>=a&&this.y1>=
b},overlaps:function(a,b,h){var f;if(b==undefined&&h==undefined)h=b=0;else if(b instanceof j||b instanceof c){b=b.x;h=b.y}if(a instanceof e){f=a.r;b=a.c.x+b;a=a.c.y+h;return this.x0-f<=b&&this.y0-f<=a&&this.x1+f>=b&&this.y1+f>=a}else if(a instanceof d)return!(this.x0>a.x1+b||this.x1<a.x0+b||this.y0>a.y1+h||this.y1<a.y0+h)},clip:function(a){return new j(Math.max(this.x0,Math.min(this.x1,a.x)),Math.max(this.y0,Math.min(this.y1,a.y)))},copy:function(){return new d(this.x0,this.y0,this.x1,this.y1)},include:function(a,
b){if(a instanceof j||a instanceof c){a=a.x;b=a.y}this.x0=Math.min(this.x0,a);this.y0=Math.min(this.y0,b);this.x1=Math.max(this.x1,a);this.y1=Math.max(this.y1,b);this.width=this.x1-this.x0+1;this.height=this.y1-this.y0+1}});this.Rectangle=this.Rectf=d;Laro.extend(this)});
Laro.register(".world",function(m){var j=m.err.assert,c=m.geometry.Rectf;m=(m.base.Class||Laro.Class)(function(a){if(a!=undefined){this.tiles=a;this.image=this.tiles[0].image;j(this.count>0,"arguments of Layer is not enough")}}).methods({count:function(){return this.tiles.length/5},offset:function(a){return a*5}});var e=m.extend(function(a,b,h,f){j(b.length==h*f);this.indices=b;this.sx=h;this.sy=f}).methods({index:function(a,b){return this.indices[a+this.sx*b]},tile:function(a,b){var h=b==null?a:
this.index(a,b);return h==-1?-1:h*5},previous:function(a,b){return a===0?b==0?-1:this.index(this.sx-1,b-1):this.index(a-1,b)}}),d=m.extend(function(a,b,h){j(h instanceof c);this.rectangles=b;this.rect=h});this.Layer=m;this.TileLayer=e;this.SpriteLayer=d;Laro.extend(this)});
Laro.register(".world",function(m){var j=m.geometry.Pixel32,c=m.geometry.Rectf,e=m.err.assert,d=m.world.Layer,a=m.world.SpriteLayer;this.Render=(m.base.Class||m.Class)(function(){this.scaleFactor=1;this.height=this.width=0;this.clips=[];this.defaultClip=null;this.frontToBack=false;this.calls=0;this.maxCalls=1E4;this.red=new j(255,0,0);this.green=new j(0,255,0);this.blue=new j(0,0,255);this.black=new j(0,0,0);this.white=new j(255,255,255);this.transparent=new j(0,0,0,0)}).methods({isFrontToBack:function(){return this.frontToBack},
clear:function(){},getWidth:function(){return this.width},getHeight:function(){return this.height},getSafeRect:function(){return new c(0,0,this.getWidth(),this.getHeight())},reset:function(b,h){e(b>0&&h>0,"invalid arguments");this.width=b;this.height=h;this.defaultClip=new c(0,0,b/this.scaleFactor,h/this.scaleFactor)},setScaleFactor:function(b){e(b>0,"factor wrong");this.scaleFactor=b;this.defaultClip=new c(0,0,this.getWidth()/this.scaleFactor,this.getHeight()/this.scaleFactor)},drawLine:function(){},
drawCircle:function(){},drawRect:function(){},drawQuad:function(){},drawTris:function(){},drawFilledRect:function(){},drawFilledTris:function(){},drawImage:function(){},drawTriangleImage:function(){},drawParticle:function(){},drawTilingImage:function(b,h,f,g,i,k){var l,n,o=b.textureWidth,q=b.textureHeight;for(l=0;l<g;l++)for(n=0;n<i;n++)this.drawImage(b,h+l*o,f+n*q,0,true,k)},drawLayer:function(b,h,f,g,i,k,l){var n,o,q,p,r,s,t;if(b instanceof d)for(o=i;o<i+l;o++){n=b.previous(g,o);var u=b.index(g+
k-1,o),v;n=n+1;for(t=n*5;n<=u;n++){v=b.tiles[t++];q=b.tiles[t++];p=b.tiles[t++];r=b.tiles[t++];s=d.tiles[t++];this.drawImage(v,h+q,f+p,0,r,1,null,s)}}else if(b instanceof a){o=this.isFrontToBack();for(n=0;n<b.count();n++){t=4*(o?this.count()-1-n:n);q=b.rectangles[t++];p=b.rectangles[t++];r=b.rectangles[t++];t=b.rectangles[t++];if(r>=g&&q<=g+k&&t>=i&&p<=i+l){t=5*(o?b.count()-1-n:n);v=b.tiles[t++];q=b.tiles[t++];p=b.tiles[t++];r=b.tiles[t++];s=b.tiles[t++];this.drawImage(v,h+q,f+p,0,r,1,null,s)}}}else e(false)},
drawText:function(){},drawCanvas:function(){},drawSystemText:function(){},drawFillScreen:function(){},pushClipRect:function(b){e(b instanceof c);this.clips.push(b)},popClipRect:function(){e(this.clips.length>0,"no clip to pop");return this.clips.pop()},getClipRect:function(){return this.clips.length==0?this.defaultClip:this.clips[this.clips.length-1]},flush:function(){this.calls=0}});Laro.extend(this)});
Laro.register(".world",function(m){var j=m.err.assert,c=m.toType,e=m.world.TileLayer,d=m.world.SpriteLayer;this.CanvasRender=m.world.Render.extend(function(a,b,h){this.canvas=a;this.context=this.canvas.getContext("2d");this.scaleFactor=c(b)=="number"?b:1;this.context.scale(this.scaleFactor,this.scaleFactor);if(this.frontToBack=h==undefined?false:h)this.context.globalCompositeOperation="destination-over";this.secondCanvas=document.createElement("canvas");this.secondContext=this.secondCanvas.getContext("2d")}).methods({getWidth:function(){return this.canvas.width||
800},getHeight:function(){return this.canvas.height||600},drawRect:function(a,b,h,f,g){a=Math.floor(a);b=Math.floor(b);h=Math.floor(h);f=Math.floor(f);this.context.lineWidth=2;this.context.strokeStyle=g.toString();this.context.strokeRect(a,b,h-a,f-b)},drawLine:function(a,b,h,f,g){a=Math.floor(a);b=Math.floor(b);h=Math.floor(h);f=Math.floor(f);this.context.lineWidth=2;this.context.strokeStyle=g.toString();this.context.beginPath();this.context.moveTo(a,b);this.context.lineTo(h,f);this.context.stroke()},
drawCircle:function(a,b,h,f){this.context.lineWidth=2;this.context.strokeStyle=f.toString();this.context.beginPath();this.context.arc(a,b,h,0,Math.PI*2,true);this.context.stroke()},drawFilledRect:function(a,b,h,f,g,i){if(!(this.calls++>this.maxCalls)){this.context.save();if(i!=undefined){var k=this.context.createLinearGradient(0,b,0,f);k.addColorStop(0,g.toString());k.addColorStop(0,i.toString());this.context.fillStyle=k}else this.context.fillStyle=g.toString();this.context.fillRect(a,b,h-a,f-b);
this.context.restore()}},drawImage:function(a,b,h,f,g,i,k,l){if(!(this.calls++>this.maxCalls)){this.context.save();if(c(i)=="number"&&i!=1)this.context.globalAlpha=i;this.context.translate(b,h);i=Math.floor(a.textureWidth/2);var n=Math.floor(a.textureHeight/2);if(c(f)=="number"&&f!=0){g||this.context.translate(i,n);this.context.rotate(f);this.context.translate(-i,-n)}else if(g){this.context.translate(-i,-n);b=-i;h=-n}if(l){b=-b;this.context.scale(-1,1);this.context.translate(-a.textureWidth,0);b-=
a.textureWidth}this.context.translate(a.offsetX,a.offsetY);b+=a.offsetX;h+=a.offsetY;this.frontToBack||this.drawEMBImage(a,b,h,f!==0,this.context);if(k&&k.a!=0){this.secondContext.clearRect(0,0,this.secondCanvas.width,this.secondCanvas.height);if(this.secondCanvas.width!=a.width)this.secondCanvas.width=a.width;if(this.secondCanvas.height!=a.height)this.secondCanvas.height=a.height;this.secondContext.save();this.drawEMBImage(a,0,0,false,this.secondContext);this.secondContext.globalCompositeOperation=
"source-in";this.secondContext.globalAlpha=k.a>1?k.a/255:k.a;this.secondContext.fillStyle=k.rgbString();this.secondContext.fillRect(0,0,this.secondCanvas.width,this.secondCanvas.height);this.secondContext.restore();this.context.drawImage(this.secondCanvas,0,0)}this.frontToBack&&this.drawEMBImage(a,b,h,f!=0,this.context);this.context.restore()}},scale:function(a){return Math.ceil(a*this.scaleFactor)/this.scaleFactor},drawEMBImage:function(a,b,h,f,g){if(a.image.complete)if(this.scaleFactor!==1&&!f){f=
this.scale(b);var i=this.scale(h),k=this.scale(b+a.width-f),l=this.scale(h+a.height-i);g.drawImage(a.image,a.x,a.y,a.width,a.height,f-b,i-h,k,l)}else g.drawImage(a.image,a.x,a.y,a.width,a.height,0,0,a.width,a.height)},drawText:function(a,b,h,f,g){if(!(this.calls++>this.maxCalls&&!g)){this.context.save();if(c(f)=="number")this.context.globalAlpha=f;this.context.drawImage(a,b,h);this.context.restore()}},clear:function(a){this.calls=0;this.context.clearRect(0,0,this.canvas.width/this.scaleFactor,this.canvas.height/
this.scaleFactor);a&&this.drawFilledRect(0,0,this.canvas.width/this.scaleFactor,this.canvas.height/this.scaleFactor,a.toString())},drawTilingImage:function(a,b,h,f,g,i){i=i==undefined?1:i;this.context.save();if(i!=1)this.globalAlpha=i;for(i=0;i<f;i++)for(var k=0;k<g;k++){this.context.save();var l=b+a.textureWidth*i-a.textureWidth/2,n=h+a.textureHeight*k-a.textureHeight/2;this.context.translate(l,n);this.drawEMBImage(a,l,n,false,this.context);this.context.restore()}this.context.restore()},drawQuad:function(a,
b){for(var h=a.length-2,f=0;f<a.length;f+=2){this.drawLine(a[f],a[f+1],a[h],a[h+1],b);h=f}},drawPoly:function(a,b){this.drawQuad(a,b)},drawTris:function(a,b){j(a.length%6!==0,"invalid points number");for(var h=a.length/6,f,g=0;g<h;g+=6){f=g+4;for(var i=g;i<g+6;i+=2){this.drawLine(a[i],a[i+1],a[f],a[f+1],b);f=i}}},drawFillScreen:function(a){if(!(this.calls++>this.maxCalls)){this.context.fillStyle=a.toString();this.context.fillRect(0,0,this.canvas.width/this.scaleFactor,this.canvas.height/this.scaleFactor)}},
drawSystemText:function(a,b,h,f){if(f instanceof m.Font){this.context.font=f.getFont();this.context.fillStyle=f.baseColor.toString();this.context.textBaseline="middle";this.context.textAlign="left";var g=f.outline*2;if(g!=0){this.context.strokeStyle=f.outlineColor.toString();this.context.lineWidth=g;this.context.strokeText(a,b,h)}}else{this.context.textBaseline="middle";this.context.textAlign="left";this.context.fillStyle=f.toString()}this.context.fillText(a,b,h)},setScaleFactor:function(a,b){b&&
this.context.scale(1/this.scaleFactor,1/this.scaleFactor);this.scaleFactor=a;this.context.scale(this.scaleFactor,this.scaleFactor);if(this.frontToBack)this.context.globalCompositeOperation="destination-over"},getContext:function(){return this.context},drawTriangleImage:function(a,b,h){var f=b[0],g=b[1],i=b[2],k=b[3],l=b[4];b=b[5];var n=h[0],o=h[1],q=h[2],p=h[3],r=h[4];h=h[5];this.context.save();this.context.beginPath();this.context.moveTo(f,g);this.context.lineTo(i,k);this.context.lineTo(l,b);this.context.closePath();
this.context.clip();var s=n*(h-p)-q*h+r*p+(q-r)*o;if(s!==0){this.context.transform(-(o*(l-i)-p*l+h*i+(p-h)*f)/s,(p*b+o*(k-b)-h*k+(h-p)*g)/s,(n*(l-i)-q*l+r*i+(q-r)*f)/s,-(q*b+n*(k-b)-r*k+(r-q)*g)/s,(n*(h*i-p*l)+o*(q*l-r*i)+(r*p-q*h)*f)/s,(n*(h*k-p*b)+o*(q*b-r*k)+(r*p-q*h)*g)/s);this.drawEMBImage(a,0,0,false,this.context);this.context.restore()}},drawParticle:function(a,b,h,f,g,i,k,l,n){if(!(this.calls++>this.maxCalls)){this.context.save();this.context.translate(b,h);if(g!=1||i!=1)this.context.scale(g,
i);if(n)this.context.globalCompositeOperation="lighter";this.drawImage(a,0,0,f,true,k,null,false);this.context.restore()}},drawCanvas:function(a,b,h){this.calls++>this.maxCalls||this.drawImage(a,b,h)},drawLayer:function(a,b,h,f,g,i,k){var l,n,o;if(a instanceof e)for(n=g;n<g+k;n++){l=a.previous(f,n);var q=a.index(f+i-1,n),p,r,s,t;l=l+1;for(o=l*5;l<=q;l++)if(!(this.calls++>this.maxCalls)){p=a.tiles[o++];r=a.tiles[o++];s=a.tiles[o++];o++;t=a.tiles[o++];r=b+r+p.offsetX;s=h+s+p.offsetY;var u=p.width,v=
p.height;if(this.scaleFactor!=1){r=this.scale(r);s=this.scale(s);u=this.scale(u);v=this.scale(v)}if(t){this.context.scale(-1,1);this.context.drawImage(p.image,p.x,p.y,p.width,p.height,-(r+u),s,u,v);this.context.scale(-1,1)}else this.context.drawImage(p.image,p.x,p.y,p.width,p.height,r,s,u,v)}}else if(a instanceof d){n=a.count;for(l=0;l<n;l++){o=4*l;p=a.rectangles[o++];t=a.rectangles[o++];q=a.rectangles[o++];o=a.rectangles[o++];if(q>=f&&p<=f+i&&o>=g&&t<=g+k)if(!(this.calls++>this.maxCalls)){o=5*l;
p=a.tiles[o++];r=a.tiles[o++];s=a.tiles[o++];q=a.tiles[o++];t=a.tiles[o++];this.drawImage(p,b+r,h+s,0,q,1,null,t)}}}else j(false)},pushClipRect:function(a){this.context.save();this.context.beginPath();this.context.moveTo(a.x0,a.y0);this.context.lineTo(a.x0,a.y1);this.context.lineTo(a.x1,a.y1);this.context.lineTo(a.x1,a.y0);this.context.lineTo(a.x0,a.y0);this.context.clip()},popClipRect:function(){this.context.restore()}});Laro.extend(this)});
Laro.register(".geometry.chaikin",function(m){var j=m.geometry.Point2;this.subDivide=function(c,e){if(c.length){do{var d=c.length;c.push(new j(c[0].x,c[0].y));for(var a=0;a<d-1;++a){var b=c[a],h=c[a+1],f=new j(0.75*b.x+0.25*h.x,0.75*b.y+0.25*h.y);b=new j(0.25*b.x+0.75*h.x,0.25*b.y+0.75*h.y);c.push(f);c.push(b)}c.push(new j(c[d-1].x,c[d-1].y));for(a=0;a<d;++a)c.shift()}while(--e>0)}};this.getLength=function(c){for(var e=0,d=null,a=1;a<c.length;a++){d=c[a].subNew(c[a-1]);e+=Math.sqrt(d.x*d.x+d.y*d.y)}return e};
this.getPointAtLength=function(c,e){if(c.length===0)return new j(0,0);if(c.length===1)return c[0];for(var d=null,a=0;a!==c.length-1;a++){d=c[a+1].subNew(c[a]);var b=Math.sqrt(d.x*d.x+d.y*d.y);if(b>e)return new j(c[a].x+d.x*e/b,c[a].y+d.y*e/b);else e-=b}return c[c.length-1]};this.getDirAtParam=function(c,e){if(c.length<2)return new j(0,0);var d=this.getLength(c);d=e*d;for(var a=null,b=0;b!==c.length-1;b++){a=c[b+1].subNew(c[b]);var h=Math.sqrt(a.x*a.x+a.y*a.y);if(h>d)return a;else d-=h}return c[c.length-
1].subNew(c[c.length-2])};this.getEvenlySpacedPoints=function(c,e,d){c=c.slice(0);var a=[],b=null;this.subdivide(c,3);var h=this.getLength(c),f=h/(e-1);a.push(c[0]);if(d){b=this.getDirAtParam(c,0);d.push(new j(-b.y,b.x))}for(var g=1;g<e-1;g++){a.push(this.getPointAtLength(c,g*f));if(d){b=this.getDirAtParam(c,g*f/h);d.push(new j(-b.y,b.x))}}a.push(c[c.length-1]);if(d){b=this.getDirAtParam(c,1);d.push(new j(-b.y,b.x))}return a};Laro.extend(this)});
Laro.register("perlin",function(m){this.start=true;this.g1=[];this.p=[];this.noise=function(j){if(this.start){this.start=false;this.init()}var c=this.setup(j,void 0,void 0,void 0,void 0);j=this.s_curve(c.rx0);return m.geometry.util.lerp(c.rx0*this.g1[this.p[c.bx0]],c.rx1*this.g1[this.p[c.bx1]],j)};this.s_curve=function(j){return j*j*(3-2*j)};this.setup=function(j){var c={};c.t=j+4096;c.bx0=Math.floor(c.t)&255;c.bx1=c.bx0+1&255;c.rx0=c.t-Math.floor(c.t);c.rx1=c.rx0-1;return c};this.init=function(){var j,
c,e;for(j=0;j<256;j++){this.p[j]=j;this.g1[j]=(Math.random()*512-256)/256}for(;--j;){e=this.p[j];c=Math.floor(Math.random()*256);this.p[j]=this.p[c];this.p[c]=e}for(j=0;j<258;j++){this.p[256+j]=this.p[j];this.g1[256+j]=this.g1[j]}}});
Laro.register(".geometry.util",function(m){var j=Array.prototype.slice,c=m.toType;this.min=Math.min;this.max=Math.max;this.clamp=function(e){var d=c(e)=="array"?e:j.call(arguments,0),a=Math.min(d[0],Math.min(d[1],d[2]));if(d.length===3){for(var b=0;b<d.length;b++)if(d[b]===a){d.splice(b,1);break}return Math.min(d[0],d[1])}};this.lerp=function(e,d,a){return e+a*(d-e)};Laro.extend(this)});
Laro.register(".input",function(m){var j={a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,"0":48,"1":49,"2":50,"3":51,"4":52,"5":53,"6":54,"7":55,"8":56,"9":57,blank:32,backspace:8,esc:27,tab:9,enter:13,"~":192,"-":189,_:189,"+":187,"=":187,"{":219,"[":219,"}":221,"]":221,"|":220,":":186,";":186,'"':222,"<":188,">":190,"?":191,up:38,down:40,left:37,right:39,shiftKey:16,ctrlKey:17,altKey:18},c=m.Class(function(e){this.target=
e||window||window.document;this.keyHash=j;this.keyStatus={};this.keyStack=[];this.keydownCallbacks={};this.keyupCallbacks={};this._upKey=this._downKey=null;this._lastKeyupTime=+new Date;this.checkTime=200;this.maxStackLength=10;this.bind()}).methods({bind:function(){var e=this;this.target.addEventListener("keydown",function(d){if(d.keyCode==32||d.keyCode==37||d.keyCode==38||d.keyCode==39||d.keyCode==40)if(d.preventDefault)d.preventDefault();else d.returnValue=false;if(!d.$keyName)d.$keyName=e.getKeyName(d.keyCode);
e.keydown(d);for(var a in e.keydownCallbacks){var b=e.keydownCallbacks[a];typeof b=="function"&&b(d)}},false);this.target.addEventListener("keyup",function(d){if(d.keyCode==32||d.keyCode==37||d.keyCode==38||d.keyCode==39||d.keyCode==40)if(d.preventDefault)d.preventDefault();else d.returnValue=false;e.keyup(d);for(var a in e.keyupCallbacks){var b=e.keyupCallbacks[a];typeof b=="function "&&b(d)}},false)},addKeydownCallback:function(e,d){this.keydownCallbacks[e]=d},addKeyupCallback:function(e,d){this.keyupCallbacks[e]=
d},removeKeydownCallback:function(e){delete this.keydownCallbacks[e]},removeKeyupCallback:function(e){delete this.keyupCallbacks[e]},getKeyName:function(e){for(var d in j)if(j[d]==e)return d;return e},keydown:function(e){if(this.keyStack.length==0||+new Date-this._lastKeyupTime>this.checkTime)this.resetKeyStack();e=this.getKeyName(e.keyCode);!this.key(e)&&this.pushToStack(e);this.keyStatus[e]=true;this._downKey=e},keyup:function(e){e=this.getKeyName(e.keyCode);this.keyStatus[e]=false;this._upKey=
e},key:function(e){return!!this.keyStatus[e]},pushToStack:function(e){var d=+new Date;if(d-this._lastKeyupTime>this.checkTime)this.resetKeyStack(d);else{this._lastKeyupTime=d;this.keyStack.push(e);e=this.keyStack.length;d=this.keyStack;if(e>this.maxStackLength)this.keyStack=d.splice(e-this.maxStackLength)}},resetKeyStack:function(e){this.keyStack=[];this._lastKeyupTime=e||+new Date}}).statics({});this.Keyboard=c;m.extend({Keyboard:c})});
